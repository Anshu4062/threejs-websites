import e from"node:path";import n from"node:process";import*as t from"@clack/prompts";import{intro as i,outro as o,spinner as r,select as a,confirm as s}from"@clack/prompts";import{WriteStream as l}from"node:tty";import{randomUUID as c,webcrypto as p}from"node:crypto";import{Axiom as d}from"@axiomhq/js";import f from"node:os";import*as u from"node:fs";import g from"node:fs";import m from"node:fs/promises";import{exec as y}from"node:child_process";import b from"node:util";import*as h from"diff";import{detect as w,parseNi as v}from"@antfu/ni";import{transformAsync as k}from"@babel/core";import*as x from"@babel/types";var j,C={reset:[0,0],bold:[1,22],dim:[2,22],italic:[3,23],underline:[4,24],overline:[53,55],inverse:[7,27],hidden:[8,28],strikethrough:[9,29],black:[30,39],red:[31,39],green:[32,39],yellow:[33,39],blue:[34,39],magenta:[35,39],cyan:[36,39],white:[37,39],gray:[90,39],bgBlack:[40,49],bgRed:[41,49],bgGreen:[42,49],bgYellow:[43,49],bgBlue:[44,49],bgMagenta:[45,49],bgCyan:[46,49],bgWhite:[47,49],bgGray:[100,49],redBright:[91,39],greenBright:[92,39],yellowBright:[93,39],blueBright:[94,39],magentaBright:[95,39],cyanBright:[96,39],whiteBright:[97,39],bgRedBright:[101,49],bgGreenBright:[102,49],bgYellowBright:[103,49],bgBlueBright:[104,49],bgMagentaBright:[105,49],bgCyanBright:[106,49],bgWhiteBright:[107,49],blackStylize:["#121212","#eeeeee18"],redStylize:["#cb7676","#ab5959"],greenStylize:["#4d9375","#1e754f"],yellowStylize:["#f6c177","#f6c17790"],blueStylize:["#6394bf","#296aa3"],magentaStylize:["#c391e6","#c391e690"],pinkStylize:["#ed9cc2","#ed9cc290"],cyanStylize:["#5eaab5","#2993a3"],whiteStylize:["#ffffff","#ffffff9f"],grayStylize:["#888888","#444444"]},$=l.prototype.hasColors(),F=(e,n)=>{if(!$)return e=>e;const t=`[${e}m`,i=`[${n}m`;return e=>{const n=`${e}`;let o=n.indexOf(i);if(-1===o)return t+n+i;let r=t,a=0;for(;-1!==o;)r+=n.slice(a,o)+t,a=o+i.length,o=n.indexOf(i,a);return r+=n.slice(a)+i,r}},M=(j=(e,n,t)=>F(`38;2;${e};${n};${t}`,39),e=>{const[n,t,i]=(e=>{let[,n]=/([\da-f]{3,6})/i.exec(e)||[];const t=n?n.length:0;if(3===t)n=n[0]+n[0]+n[1]+n[1]+n[2]+n[2];else if(6!==t)return[0,0,0];const i=Number.parseInt(n,16);return[i>>16&255,i>>8&255,255&i]})(e);return j(n,t,i)}),S=F(...C.bold),L=F(...C.dim),E=F(...C.cyanBright);M(C.blackStylize[0]),M(C.blackStylize[1]);var N=M(C.redStylize[0]);M(C.redStylize[1]);var z=M(C.greenStylize[0]);M(C.greenStylize[1]);var I=M(C.yellowStylize[0]);M(C.yellowStylize[1]),M(C.blueStylize[0]),M(C.blueStylize[1]);var P=M(C.magentaStylize[0]);M(C.magentaStylize[1]);var D=M(C.pinkStylize[0]);M(C.pinkStylize[1]);var A=M(C.cyanStylize[0]);M(C.cyanStylize[1]),M(C.whiteStylize[0]);var O=M(C.whiteStylize[1]),_=M(C.grayStylize[0]);M(C.grayStylize[1]);var B,R,V="useandom-26T198340PX75pxJACKVERYMINDBUSHWOLF_GQZbfghjklqvwyzrict",T=128;function W(e=21){var n;n=e-=0,!B||B.length<n?(B=Buffer.allocUnsafe(n*T),p.getRandomValues(B),R=0):R+n>B.length&&(p.getRandomValues(B),R=0);let t="";for(let i=(R+=n)-e;i<R;i++)t+=V[63&B[i]];return t}var U=(n=>{const t=f.homedir();switch(process.platform){case"darwin":return e.join(t,"Library","Preferences",n);case"win32":return(()=>{const{APPDATA:i=e.join(t,"AppData","Roaming")}=process.env;return e.join(i,n,"Config")})();default:return(()=>{const{XDG_CONFIG_HOME:i=e.join(t,".config")}=process.env;return e.join(i,n)})()}})("million-lint"),G=c(),J=async()=>{if(!G)try{g.statSync(e.join(U,"machineId.txt")).isFile()&&(G=g.readFileSync(e.join(U,"machineId.txt"),"utf8")||G)}catch(e){}return G},q=new d({token:"xaat-137e6732-9a45-48d9-b12c-964c9fa88ed3"}),H=async(e,...n)=>{q.ingest("install",{level:e,env:Ye,machineId:J(),message:JSON.stringify(n)}),await q.flush()},Y=q.flush;function K({type:e="error",distinctId:n=`r-${W(10)}`,event:i,message:o,properties:r={},needAbort:a}){if(a)return function({title:e,message:n,properties:i={},status:o,distinctId:r=`r-${W(10)}`,type:a="error"}){H("error",{distinctId:r,title:e,message:n,...i}),n&&t.log[a](n);"error"===a&&(t.log.error(`${N("Setup failed.")} Continue via ${A("http://million.dev/docs")}`),t.log.message());X().then((()=>process.exit(o??1)))}({title:i,message:o,type:e});o?("error"===e?t.log.error(o):t.note(o,i),H(e,{distinctId:n,event:i,message:o,...r})):H(e,{distinctId:n,event:i,...r})}var X=async()=>{try{await Y()}catch{process.exit(1)}};async function Z(e,n){const i=await e;if(!t.isCancel(i))return e;K({event:"wizard-cancel",properties:{body:i}}),n&&await n(),t.cancel("Million Lint setup cancelled."),await X(),process.exit(1)}function Q(e,n,i,o=1){const r=h.diffWords(e,n);let a="";r.forEach(((e,n)=>{const t=n>0&&(r[n-1]?.added||r[n-1]?.removed),i=n<r.length-1&&(r[n+1]?.added||r[n+1]?.removed);let s="";if(e.added)s=z(S(e.value));else if(e.removed)s=N(e.value);else if(t&&i){const n=e.value.split("\n");s=n.length-1>2*o?[n.slice(0,o).join("\n"),"...",n.slice(-o-1).join("\n")].join("\n"):L(e.value)}else t?s=e.value.split("\n").slice(0,o+1).join("\n"):i&&(s=e.value.split("\n").slice(-o-1).join("\n"));a+=s})),t.note(a,`Take a look at changes in ${A(i)}`)}var ee=b.promisify(y);var ne=(e,n)=>{try{let t=!1;const i=((e,n)=>{let t;return new Promise(((i,o)=>{e.then((e=>{t&&clearTimeout(t),i(e)})).catch((()=>{o(new Error)})),t=setTimeout((()=>{o(new Error)}),n)}))})(e,n).catch((()=>{t=!0}));if(t)return;return i}catch(e){return}};var te=[{label:"Visual Studio Code",value:"code"},{label:"Visual Studio Code Insiders",value:"code-insiders"},{label:"Cursor",value:"cursor"}],ie=async e=>{e.stop(`Unable to install via CLI. Install here: ${E("https://marketplace.visualstudio.com/items?itemName=million.million-lint")}`),K({event:"wizard-cli-install-failed"});await Z(s({message:"Would you like to continue anyway?"}))||process.exit(0)},oe=async()=>{const e=r(),n=(await Promise.all(te.map((e=>(async e=>{try{const n=await ne(ee(`${e.value} --version`),3e3);if(n.stderr)return K({event:"wizard-command-check-failed",message:n.stderr}),null;if(n?.stdout)return e}catch{}return null})(e))))).filter(Boolean);if(e.start("Installing VSCode extension"),n.length){let t=Ye.CLI_COMMAND;n.length>1&&(t=await Z(a({message:"Which IDE are you using?",options:n.map((e=>({label:e.label,value:e.value})))}))),Ye.CLI_COMMAND=String(t),Ye.IDE_NAME=te.find((e=>e.value===t))?.label||null,Ye.IDE_VERSION=await(async e=>{try{const n=await ne(ee(`${e} --version`),3e3);if(n.stderr)return K({event:"wizard-command-version-failed",message:n.stderr}),null;if(n?.stdout)return n.stdout.split("\n")[0]}catch{}return null})(t);const i=await(async e=>{try{const n=await ne(ee(`${e} --list-extensions --show-versions`),3e3);if(n?.stderr)return K({event:"wizard-extension-check-failed",message:n?.stderr}),!1;const t=n?.stdout.split("\n");if(t)for(const e of t)if(e.includes("million.million-lint"))return Ye.MILLION_VERSION=e,!0}catch{}return!1})(t);await(async()=>{const e=await ne(ee(`${Ye.CLI_COMMAND} --install-extension million.million-lint --force`),2e4);return e?.stderr?(K({event:"wizard-extension-install-failed",message:e?.stderr}),!1):Boolean(!e?.stdout.toLowerCase().includes("failed")&&e?.stdout)})()?i?e.stop("Updated VSCode extension"):e.stop("Installed VSCode extension"):await ie(e)}else await ie(e)},re={name:"yarn",label:"yarn",lockFile:"yarn.lock",installCommand:"yarn add",dlxCommand:"npx"},ae={name:"pnpm",label:"pnpm",lockFile:"pnpm-lock.yaml",installCommand:"pnpm install",dlxCommand:"pnpx"},se={name:"npm",label:"npm",lockFile:"package-lock.json",installCommand:"npm install",dlxCommand:"npx"},le={name:"bun",label:"bun",lockFile:"bun.lockb",installCommand:"bun add",dlxCommand:"bunx"},ce=[ae,re,le,se],pe={name:"craco",label:"Create React App",bundler:"webpack",prefix:"MillionLint.craco",configFilePath:"craco.config.js",possibleFileNames:["craco.config.js","craco.config.mjs","craco.config.cjs","craco.config.ts"],millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [MillionLint.craco()],\n};"}},de=[{name:"next",label:"Next.js",bundler:"next",prefix:"MillionLint.next",configFilePath:"next.config.mjs",possibleFileNames:["next.config.js","next.config.mjs"],millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next()(nextConfig);",configFileContentRSC:"import MillionLint from '@million/lint';\n\n/** @type {import('next').NextConfig} */\nconst nextConfig = {\n  reactStrictMode: true,\n};\n\nexport default MillionLint.next({ rsc: true })(nextConfig);"}},{name:"astro",label:"Astro",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"astro.config.mjs",possibleFileNames:["astro.config.js","astro.config.mjs","astro.config.cjs","astro.config.ts"],millionLint:{configFileContent:"import { defineConfig } from 'astro/config';\nimport MillionLint from '@million/lint';\n\nexport default defineConfig({\n  integrations: [MillionLint.astro()]\n});"}},{name:"gatsby",label:"Gatsby",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"gatsby-node.js",possibleFileNames:["gatsby-node.js","gatsby-node.ts"],otherPossibleFileNames:["gatsby-config.js","gatsby-config.ts"],millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\n\nexports.onCreateWebpackConfig = ({ actions }) => {\n  actions.setWebpackConfig({\n    plugins: [MillionLint.webpack()],\n  })\n};"}},{name:"vite",label:"Vite",bundler:"vite",prefix:"MillionLint.vite",configFilePath:"vite.config.js",possibleFileNames:["vite.config.js","vite.config.mjs","vite.config.mts","vite.config.cjs","vite.config.ts"],millionLint:{configFileContent:"import MillionLint from '@million/lint';\nimport react from \"@vitejs/plugin-react\";\nimport { defineConfig } from 'vite';\n\nexport default defineConfig({\n  plugins: [MillionLint.vite(), react()],\n});"}},pe,{name:"webpack",label:"Webpack",bundler:"webpack",prefix:"MillionLint.webpack",configFilePath:"webpack.config.js",possibleFileNames:["webpack.config.js","webpack.config.cjs","webpack.config.mjs","webpack.config.ts"],millionLint:{configFileContent:"const MillionLint = require('@million/lint').default;\nconst MillionLint = require('@million/lint').default;\nmodule.exports = {\n  plugins: [\n    MillionLint.webpack(),\n  ],\n};"}},{name:"rollup",label:"Rollup",bundler:"rollup",prefix:"MillionLint.rollup",configFilePath:"rollup.config.js",possibleFileNames:["rollup.config.js","rollup.config.mjs","rollup.config.cjs","rollup.config.ts"],millionLint:{configFileContent:"import MillionLint from '@million/lint';\n\nexport default {\n  plugins: [MillionLint.rollup()],\n};"}}];async function fe({packageManager:e,packageNames:n,flags:i=[],cwd:o}){try{const r=`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${i.join(" ")}`;t.log.info(`Running: ${r}`);const{stderr:a}=await ee(r,{cwd:o});if(a){t.log.error(N(a)),"npm"===e.name&&i.push("--legacy-peer-deps"),"yarn"!==e.name&&"pnpm"!==e.name||i.push("--ignore-workspace-root-check");const s=`${e.installCommand} ${n.map((e=>`${e}@latest`)).join(" ")} ${i.join(" ")}`;if(s===r)return;t.log.info(`Running: ${s}`);const{stderr:l}=await ee(s,{cwd:o});l&&t.log.error(N(l))}}catch(e){K({event:"wizard-failed-install-package",message:e.stdout||e.stderr||e.message,properties:{body:e},needAbort:!0})}}var ue=null;async function ge(e){if(ue)return ue;const n=await async function(e){const n=await w({cwd:e});if(!n)return null;const[t]=n.split("@");switch(t){case"yarn":return re;case"pnpm":return ae;case"npm":return se;case"bun":return le;default:return null}}(e);if(n)ue=n;else{const e=await Z(t.select({message:"Please select your package manager.",options:ce.map((e=>({value:e,label:e.label,hint:`Be sure you have ${S(e.label)} installed.`})))}));ue=e}return ue}function me(e){return!!e&&!!e.includes("react-scripts start")}async function ye(n,i,o){if(me(n)){let r=n;r=r.replace("react-scripts start","craco start"),r=r.replace("react-scripts build","craco build"),r=r.replace("react-scripts test","craco test");const a=["@craco/craco",...i].map((e=>A(S(e)))).join(", ");try{const n=await ge(o);await u.promises.writeFile(e.join(o,"package.json"),r),await u.promises.writeFile(e.join(o,"craco.config.js"),pe.millionLint.configFileContent);const s=t.spinner();s.start(`Installing ${a}...`),await fe({packageManager:n,packageNames:["@craco/craco"],cwd:o,flags:["-D"]}),await fe({packageManager:n,packageNames:i,cwd:o}),s.stop(`${a} installed.`)}catch(e){return K({event:"wizard-error-install-craco",message:`Could not install ${a}. Please install it manually.`,properties:{body:e}})}}}async function be(n){const t=await async function(n){let t;try{t=await m.readFile(e.join(n,"package.json"),"utf8")}catch{return void K({event:"wizard-package-json-not-found",message:"Could not find package.json. Make sure to run the wizard in the root of your app!"})}return t}(n);if(!t)return;let i;try{i=JSON.parse(t)}catch{return K({event:"wizard-package-json-parse-error",message:"Unable to parse your package.json. Make sure it has a valid format!",needAbort:!0})}return{packageJson:i,packageJsonContents:t}}var he=async()=>{const n=Ye.CWD,i=await be(n);if(!i)return;const o=await async function({packageJsonContents:n,packages:i,cwd:o}){const r=[];for(const a of de){if("craco"===a.name&&me(n))return await Z(await t.confirm({message:"Ordinary create-react-app projects are not supported. Do you want to use craco instead of react-scripts?"}))?void await ye(n,i,o):void K({event:"wizard-craco-not-installed",message:"Please install craco manually: https://craco.js.org/docs/getting-started",needAbort:!0});for(const n of a.possibleFileNames)if(u.existsSync(e.join(o,n))){const e={...a,configFilePath:n};r.push({buildTool:e})}else if(u.existsSync(e.join(o,"config",n))){const t={...a,configFilePath:e.join("config",n)};r.push({buildTool:t})}if("gatsby"===a.name)for(const n of a.otherPossibleFileNames)if(u.existsSync(e.join(o,n))){const n=a;await u.promises.writeFile(e.join(o,a.configFilePath),a.millionLint.configFileContent),r.push({buildTool:n,skipUpdateConfigFile:!0})}}if(r.length){if(1===r.length)return t.log.success(`Detected ${A(S(r[0].buildTool.label))} project.`),r[0];const e=await Z(await t.select({message:"Detected multiple build tools. Please select one:",options:r.map((e=>({label:e.buildTool.label,value:e.buildTool.name,hint:e.buildTool.configFilePath}))),initialValue:r[0].buildTool.name}));return r.find((n=>n.buildTool.name===e))}K({event:"wizard-no-build-tool-detected",message:`No build tool detected. No configuration file found in the current path: ${o}`,needAbort:!0})}({packageJsonContents:i.packageJsonContents,packages:["@million/lint"],cwd:n}),{buildTool:r,skipUpdateConfigFile:a}=o||{};return r&&(Ye.BUILD_TOOL=r.name),{...i,buildTool:r,skipUpdateConfigFile:a}},we=async()=>{const e=Ye.CWD,n=await async function(e,n=["@million/lint"]){const t=[],i=await be(e),o=i?.packageJson;for(const e of n)o?.dependencies?.[e]&&t.push(e);return t}(e,["@million/lint"]);await async function({packageNames:e,alreadyInstalledPackageNames:n,askBeforeUpdating:i=!0,cwd:o,packageManager:r}){const a=e.map((e=>A(S(e)))).join(", "),s=n?.map((e=>A(S(e)))).join(", ");if(s?.length&&i&&!await Z(t.confirm({message:`The ${s} package is already installed. Do you want to update it to the latest version?`})))return;r=r||await ge(o),Ye.PACKAGE_MANAGER=r.name;const l=t.spinner();l.start(`${n?.length?"Updating":"Installing"} ${a} with ${S(r.label)}.`);try{await fe({packageManager:r,packageNames:e,cwd:o}),K({type:"info",event:"wizard-package-manager",properties:{body:JSON.stringify(r)}}),l.stop(`${n?.length?"Updated":"Installed"} ${a} with ${S(r.label)}.`)}catch(e){K({event:"wizard-failed-install",message:e,properties:{body:e}});const n="npm"===r.name&&e.message.includes("npm ERR"),i="yarn"===r.name&&e.message.includes("error "),o="pnpm"===r.name&&e.message.includes("ERR_"),a="bun"===r.name&&e.message.includes("error: "),s=n||i||o||a?"Error":"Warnings";if(t.log.error(N(`${s} during installation. ${e}`)),l.stop(),!await Z(t.confirm({message:"Would you like to continue anyway?"})))return K({event:"wizard-abort",properties:{body:e.message},needAbort:!0})}}({packageNames:["@million/lint"],alreadyInstalledPackageNames:n,cwd:e})},ve=new Set(["<",">","{","}","[","]"]),ke=new Set(["for","do","while","if","else","return","function","var","let","const","true","false","undefined","this","new","delete","typeof","in","instanceof","void","break","continue","switch","case","default","throw","try","catch","finally","debugger","with","yield","async","await","class","extends","super","import","export","from","static"]),xe=new Set(["+","-","*","/","%","=","!","&","|","^","~","!","?",":",".",",",";","'",'"',".","(",")","[","]","#","@","\\",...ve]),[je,Ce,$e,Fe,Me,Se,Le,Ee,Ne,ze,Ie]=["identifier","keyword","string","class","property","entity","jsxliterals","sign","comment","break","space"].map(((e,n)=>n));function Pe(e){return/^[^\S\r\n]+$/g.test(e)}function De(e){return xe.has(e)}function Ae(e){return/^[\w_]+$/.test(e)||Oe(e)}function Oe(e){return/[^\u0000-\u007f]/.test(e)}function _e(e){return/^[a-zA-Z]$/.test(e)}function Be(e){return _e(e)||Oe(e)}function Re(e){return Be(e[0])&&(1===e.length||Ae(e.slice(1)))}function Ve(e){return"`"===e}function Te(e){return'"'===e||"'"===e}function We(e){return"//"===(e=e.slice(0,2))||"/*"===e}function Ue(e){let n="",t=-1,i=[-1,""],o=[-2,""];const r=[];let a=!1,s=0,l=!1,c=0;const p=()=>a&&!l&&!s,d=()=>s&&!p(),f=()=>!s&&p()&&!l&&c>0;let u=null,g=0,m=0;const y=()=>null!==u,b=()=>m>g,h=()=>y()||b();function w(e){const n="\n"===e;if(d()){if(y())return $e;const[,n]=i;if(Re(e)&&("<"===n||"</"===n))return Se}if(f())return Le;if(y())return $e;if(ke.has(e))return"."===i[1]?je:Ce;if(n)return ze;if(Pe(e))return Ie;if(e.split("").every(De))return Ee;if(function(e){const n=e[0];return Ae(n)&&n===n.toUpperCase()||"null"===e}(e))return d()?je:Fe;if(Re(e)){const e="."===i[1]&&Re(o[1]);if(!h()&&!e)return je;if(e)return Me}return $e}const v=(e,a)=>{if(a&&(n=a),n){t=e||w(n);const a=[t,n];t!==Ie&&t!==ze&&(o=i,i=a),r.push(a)}n=""};for(let t=0;t<e.length;t++){const o=e[t],r=e[t-1],d=e[t+1],y=r+o,w=o+d;if(Te(o)&&!f()){v(),"\\"!==r&&(u&&o===u?u=null:u||(u=o)),v($e,o);continue}if(!b()&&"\\n"!==r&&Ve(o)){v(),v($e,o),m++;continue}if(b()){if("\\n"!==r&&Ve(o)&&m>0){v(),m--,v($e,o);continue}if("${"===w){g++,v($e),v(Ee,w),t++;continue}}if(m>0&&m===g&&"}"===o){v(),g--,v(Ee,o);continue}if(p()&&"{"===o){v(),v(Ee,o),l=!0;continue}if(a){if(!s&&"<"===o){v(),"/"===d?(s=2,n=w,t++):(s=1,n=o),v(Ee);continue}if(s){if(">"===o&&!"/=".includes(r)){v(),1===s?(s=0,c++):(s=0,a=!1),v(Ee,o);continue}if("/>"===w||"</"===w){"<"!==n&&"/"!==n&&v(),"/>"===w?s=0:c--,c||(a=!1),n=w,t++,v(Ee);continue}if("<"===o){v(),n=o,v(Ee);continue}if("-"===d&&!h()&&!f()&&n){v(Me,n+o+d),t+=1;continue}if("="===d&&!h()){const e=n?n+o:o;Re(e)&&(n=e,v(Me));continue}}}!s&&("<"===o&&Be(d)||"</"===w)&&(s="/"===d?2:1,"<"!==o||"/"!==d&&!_e(d)||(a=!0));const j=Te(x=o)||Ve(x),C=b(),$=!a&&("/"===(k=w)[0]&&!We(k[0]+k[1])),F=f();if(j||C||Te(u))n+=o;else if($){v();const[r,a]=i;if($&&-1!==r&&(r!==Ee||")"===a)&&r!==Ne){n=o,v();continue}const s=t++,l=()=>t>=e.length,c=()=>l()||"\n"===e[t];let p=!1;for(;!c();t++)if("/"===e[t]&&"\\"!==e[t-1]){for(p=!0;s!==t&&/^[a-z]$/.test(e[t+1])&&!c();)t++;break}s!==t&&p?(n=e.slice(s,t+1),v($e)):(n=o,v(),t=s)}else if(We(w)){v();const i=t;if("/"===d)for(;t<e.length&&"\n"!==e[t];t++);else for(;t<e.length&&e[t-1]+e[t]!=="*/";t++);n=e.slice(i,t+1),v(Ne)}else" "===o||"\n"===o?" "!==o||!Pe(n)&&n&&!F?(v(),n=o,v()):(n+=o,"<"===d&&v()):l&&"}"===o?(v(),n=o,v(),l=!1):F&&!ve.has(o)||(Ae(o)===Ae(n[n.length-1])||p())&&!xe.has(o)?n+=o:("</"===y&&(n=y),v(),"</"!==y&&(n=o),"</"===w||"/>"===w?(n=w,v(),t++):ve.has(o)&&v())}var k,x;return v(),r}function Ge(e,n={showLineNumbers:!1}){const t=Ue(e),i=[];let o=1;const r=[];function a(e){i.push(function(e){const t=n.showLineNumbers?`${L(`${o}`.padEnd(2," "))} `:"";return o++,`${t}${e}`}(e.map((([e,n])=>{switch(e){case 0:case 4:return D(n);case 1:case 2:case 7:return _(n);case 3:return I(n);case 5:return P(n);case 6:return O(n);case 8:return L(n);default:return n}})).join("")))}for(const e of t){const[n,t]=e;if(9!==n)if(t.includes("\n")){const e=t.split("\n");for(let t=0;t<e.length;t++)r.push([n,e[t]]),t<e.length-1&&(a(r),r.length=0)}else r.push(e);else r.push([n,""]),a(r),r.length=0}return r.length>0&&a(r),i.join("\n")}var Je=async n=>{if(!n.check?.buildTool)return;if(n.check?.skipUpdateConfigFile)return;const i=Ye.CWD,o=n.check.buildTool;let r;t.note(`found existing ${o.configFilePath} file.`,`Transforming ${A(o.configFilePath)}`);try{let n=await async function(n,t){const i=e.join(t,n.configFilePath);return await m.readFile(i,{encoding:"utf-8"})}(o,i);const a=n,s=e.join(i,o.configFilePath);let l=!1;if(n.includes("@million/lint")&&n.includes("MillionLint")&&(l=!0),l)return K({type:"info",event:"wizard-already-configured",message:z(`@million/lint is already configured in ${o.configFilePath}.`)});const c=t.spinner(),p=function(e){if(e.includes("module.exports =")||e.includes("exports."))return"cjs";if(e.includes("export default"))return"esm";return"unknown"}(n);if(K({type:"info",event:"wizard-modify-config",properties:{body:{type:p,oldCode:a,filePath:s}}}),"unknown"===p)return K({event:"wizard-unknown-module-type",message:"Unknown module type. Aborting.",needAbort:!0});let d;n=("esm"===p?"import MillionLint from '@million/lint';\n":"const MillionLint = require('@million/lint');\n")+n,"next"===o.name&&(d=await async function(){return g.existsSync("pages")?"pages":g.existsSync("app")?"app":g.existsSync("src/pages")?"pages":g.existsSync("src/app")?"app":await Z(t.select({message:"Will you use app Router or pages Router?",options:[{label:"App Router",value:"app"},{label:"Pages Router",value:"pages"}]}))}()),c.start(`Modifying config file ${A(o.configFilePath)}...`);const f=o.millionLint.configFileContent,u=o.millionLint.configFileContentRSC;r="app"===d?u:f;const y=await async function(e,n,t){const{name:i,bundler:o}=n;try{const n=(e,n,r)=>{const a=n(e),s=()=>x.callExpression(x.memberExpression(x.identifier("MillionLint"),x.identifier(o)),"craco"===i?[x.objectExpression([x.objectProperty(x.identifier("legacyHmr"),x.booleanLiteral(!0))])]:t?[x.objectExpression([x.objectProperty(x.identifier("rsc"),x.booleanLiteral(!0))])]:[]),l=()=>{const e=[];return e.push(s()),e};if("next"===i){if(x.isClassDeclaration(a)||x.isFunctionDeclaration(a)||x.isTSDeclareFunction(a))return;r(x.callExpression(s(),[a]))}if("vite"===i||"webpack"===i||"rollup"===i||"esbuild"===i||"rspack"===i||"craco"===i||"gatsby"===i||"astro"===i){let n=!1;if(e.traverse({ObjectProperty(t){if("craco"===i){if(x.isIdentifier(t.node.key)&&"plugins"===t.node.key.name&&x.isProperty(t.node)&&!x.isPattern(t.node.value)&&!x.isRestElement(t.node.value)&&!x.isIdentifier(t.node.value)){let i;n=!0,i=x.isObjectExpression(t.node.value)&&t.node.value.properties.some((e=>x.isObjectProperty(e)&&x.isIdentifier(e.key)&&"add"===e.key.name))?t.node.value.properties.find((e=>x.isObjectProperty(e)&&x.isIdentifier(e.key)&&"add"===e.key.name)):x.objectProperty(x.identifier("add"),x.arrayExpression(l())),e.insertBefore([x.variableDeclaration("const",[x.variableDeclarator(x.identifier("_plugins"),i.value)]),x.callExpression(x.memberExpression(x.identifier("_plugins"),x.identifier("unshift")),l())]),x.isObjectExpression(t.node.value)&&(t.node.value.properties=t.node.value.properties.filter((e=>!(x.isObjectProperty(e)&&x.isIdentifier(e.key)&&"add"===e.key.name))),t.node.value.properties.push(x.objectProperty(x.identifier("add"),x.identifier("_plugins"))))}}else!x.isIdentifier(t.node.key)||"plugins"!==t.node.key.name||!x.isProperty(t.node)||x.isPattern(t.node.value)||x.isRestElement(t.node.value)||x.isIdentifier(t.node.value)||(n=!0,e.insertBefore([x.variableDeclaration("const",[x.variableDeclarator(x.identifier("_plugins"),t.node.value)]),x.callExpression(x.memberExpression(x.identifier("_plugins"),x.identifier("unshift")),l())]),t.node.value=x.identifier("_plugins"))}}),!n){let n;const t=x.variableDeclaration("const",[x.variableDeclarator(x.identifier("_plugins"),x.arrayExpression(l()))]),o=x.objectProperty(x.identifier("plugins"),x.identifier("_plugins"));if(e.insertBefore([t]),"astro"===i){let e;a&&"CallExpression"===a.type&&x.isIdentifier(a.callee)&&"defineConfig"===a.callee.name&&(n=a.arguments[0]),n?.properties.length?e=n.properties.find((e=>!("ObjectProperty"!==e.type||!x.isIdentifier(e.key)||"vite"!==e.key.name||"ObjectExpression"!==e.value.type)))||x.objectProperty(x.identifier("vite"),x.objectExpression([o])):(e=x.objectProperty(x.identifier("vite"),x.objectExpression([o])),n=x.objectExpression([e])),a&&"CallExpression"===a.type&&x.isIdentifier(a.callee)&&"defineConfig"===a.callee.name&&(a.arguments[0]=n)}else"gatsby"===i?e.traverse({CallExpression(e){x.isMemberExpression(e.node.callee)&&x.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(n=e.node.arguments[0]),n?.properties.length?n.properties.push(o):n=x.objectExpression([o]),x.isMemberExpression(e.node.callee)&&x.isIdentifier(e.node.callee.property)&&"setWebpackConfig"===e.node.callee.property.name&&(e.node.arguments[0]=n)}}):"craco"===i?x.isObjectExpression(a)&&a.properties.push(x.objectProperty(x.identifier("webpack"),x.objectExpression([x.objectProperty(x.identifier("add"),x.identifier("_plugins"))]))):x.isObjectExpression(a)&&a.properties.push(o)}}},r=()=>({name:"wizard",visitor:{MemberExpression(e){const t=x.isIdentifier(e.node.object)&&"module"===e.node.object.name&&x.isIdentifier(e.node.property)&&"exports"===e.node.property.name,i=x.isIdentifier(e.node.object)&&"exports"===e.node.object.name;if(t||i){if(!x.isAssignmentExpression(e.parent))return;n(e.parentPath,(e=>e.node.right),(n=>{e.node.right=n}))}},ExportDefaultDeclaration(e){n(e,(e=>e.node.declaration),(n=>{e.node.declaration=n}))}}}),a=await k(e,{plugins:[r()],parserOpts:{plugins:["jsx","typescript"]}});return a?(K({type:"info",event:"wizard-success-modify-config",properties:{body:JSON.stringify(a)}}),a.code):null}catch(e){return K({event:"wizard-failed-get-new-file-content",message:"Unable to modify config file.",properties:{body:e},needAbort:!0}),null}}(n,o,"app"===d);if(!y)return K({event:"wizard-no-changes-made",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${Ge(r,{showLineNumbers:!0})}`,needAbort:!0});const b=`${s}.temp`;await m.writeFile(b,y,{encoding:"utf-8",flag:"w"}),Q(a,y,o.configFilePath),Ye.IDE_NAME?(await async function(e,n){try{await ee(`${Ye.CLI_COMMAND} --diff ${e} ${n}`)}catch(e){K({event:"wizard-open-diff-failed",message:`Failed to open diff in ${Ye.IDE_NAME}`,properties:{body:e}})}}(s,b),c.stop(`Check ${A(o.configFilePath)} in ${S(String(Ye.IDE_NAME))} to review changes.`)):c.stop();const h=async()=>{await m.unlink(b),K({event:"wizard-reverted-changes",message:`Reverted the changes.\n\nHere is an installation reference:\n\n${Ge(r,{showLineNumbers:!0})}`,needAbort:!0})};await Z(t.confirm({message:"Does the config file look good?",initialValue:!0}),h)?await m.rename(b,s):await h()}catch(e){return t.log.error(e),K({event:"wizard-failed-modify-config",message:`Failed to modify config file.\n\nHere is an installation reference:\n\n${Ge(r,{showLineNumbers:!0})}`,needAbort:!0})}},qe=async()=>{const n=Ye.CWD;await async function(n){if(!n)return;const t="# Million Lint\n.million\n",i=e.join(n,".gitignore");if(g.existsSync(i)){const e=await m.readFile(i,"utf-8");if(e.includes(".million"))return;const n=`${e}\n${t}`;await m.writeFile(i,n),Q(e,n,i)}else{const e=t;await m.writeFile(i,e),Q("",e,i)}}(n)};async function He(n){try{t.intro(P(`⚡ ${S("Million Lint beta")}`)),await async function(n){const i=e.join(process.cwd());await t.group({getVersions:async()=>{const e=t.spinner();try{let{npmVersion:i,vscodeVersion:o}=n.reduce(((e,n)=>{try{const[t,i]=n.split("=");return{...e,[t.split("--")[1]]:i}}catch{return e}}),{npmVersion:"",vscodeVersion:""});if(!i||!o){e.start("Fetching latest versions");let n="version.txt";i?n=`version-npm-${i}.txt`:o&&(n=`version-vscode-${o}.txt`);const t=await fetch(`https://beta-lint-r2.million.dev/${n}`).then((e=>e.text())).then((e=>{const[n,t]=e.split("\n");return{npm:i||n,vscode:o||t}}));i=t.npm,o=t.vscode,e.stop()}return t.note(`Downloading packages for NPM ${i} and VSCode ${o}`,"Get ready to install the packages."),{npmVersion:i,vscodeVersion:o}}catch(n){return e.stop(),K({event:"beta-error",message:"Failed to fetch versions",properties:{body:n}})}},fetchPackages:async({results:n})=>{if(!n.getVersions)return;const o=t.spinner();try{const{npmVersion:t,vscodeVersion:r}=n.getVersions;o.start("Downloading packages");const a=await fetch(`https://beta-lint-r2.million.dev/million-lint-${t}.tgz`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),s=e.join(i,`million-lint-${t}.tgz`);await m.writeFile(s,a);const l=await fetch(`https://beta-lint-r2.million.dev/million-lint-${r}.vsix`).then((e=>e.arrayBuffer())).then((e=>Buffer.from(e))),c=e.join(i,`million-lint-${r}.vsix`);await m.writeFile(c,l),o.message(`Downloaded packages: NPM ${t}, VSCode ${r}`);const p=await w({programmatic:!0,cwd:i});if(!p)return K({event:"beta-error",message:"No package manager found",properties:{body:"No package manager found"}});const d=await v(p,[s]);if(!d)return K({event:"beta-error",message:"Failed to create install command",properties:{body:"Failed to create install command"}});const{stderr:f}=await ee(d);if(f)return K({event:"beta-error",message:"Failed to install packages",properties:{body:f}});const u=`code --install-extension ${c}`,{stderr:g}=await ee(u);if(g)return K({event:"beta-error",message:"Failed to install packages",properties:{body:g}});await m.unlink(s),await m.unlink(c),o.stop()}catch(e){return o.stop(),K({event:"beta-error",message:"Failed to fetch packages",properties:{body:e}})}}},{onCancel:({results:e})=>{K({event:"beta-cancel",properties:{body:e}}),t.cancel("Million beta cancelled."),X().then((()=>process.exit(1)))}})}(n),t.outro(`${z(S("✓ "))} You're all set! Enjoy! 🎉`)}catch(e){K({event:"beta-error",message:e,properties:{body:e}})}}var Ye={NAME:"",CWD:n.cwd(),CLI_COMMAND:"code",IDE_NAME:null,IDE_VERSION:null,MILLION_VERSION:null,INSTALL_VERSION:null,PACKAGE_MANAGER:"npm",BUILD_TOOL:null};async function Ke(r,a=n.env.VERSION){try{Ye.NAME=r||"",Ye.INSTALL_VERSION=a||"",Ye.CWD=e.join(n.cwd()),i(P(`⚡ ${S(r)} ${L(a||"")}`)),await async function(){await t.group({vscode:async()=>oe(),check:async()=>he(),install:async()=>we(),updateConfigFile:async({results:e})=>Je(e),others:async()=>qe()},{onCancel:({results:e})=>{K({event:"wizard-cancel",properties:{body:e}}),t.cancel("Million Lint setup cancelled."),X().then((()=>n.exit(1)))}}),K({type:"info",event:"wizard-complete",properties:{body:!0}}),X().then((()=>n.exit(1)))}(),o(`${z(S("✓ "))} You're all set!`)}catch(e){K({event:"wizard-error",message:e,properties:{body:e}})}}export{Ye as TelemetryStore,He as beta,Ke as install};